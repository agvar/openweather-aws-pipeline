name : Deploy and Cleanup
on :
  workflow_run:
   workflows: ["CI"]
   types : [completed]
   branches: [main]

jobs:
  deploy-and-test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
     id-token : write
     contents : read
    steps:
    - name : Debug OIDC Github token 
      run : |
       echo "GITHUB_TOKEN info:"
       echo "Rep: ${{ github.repository }}"
       echo "Rep: ${{ github.repository }}"
       echo "Rep: ${{ github.ref }}"
       echo "Rep: ${{ github.sha }}"
       echo "Rep: ${{ github.actor }}"
       echo "Rep: ${{ github.event_name }}"
    - name : Configure AWS credentials for github actions
      uses : aws-actions/configure-aws-credentials@v2
      with : 
       role-to-assume : ${{ secrets.AWS_ROLE_ARN }}
       aws-region : us-east-1
       audience: sts.amazonaws.com
       
    - name : checkout code
      uses : actions/checkout@v3
    - name : Setup Terraform
      uses : hashicorp/setup-terraform@v2

    - name: Create AWS Resources
      run: |
       cd terraform
       terraform init
       terraform apply -var="create_ephemeral_resources_flag=true" -auto-approve

    - name: Deploy Lambda aws_lambda_function
      run: |
       zip -r weather-collector.zip src/
       aws s3 cp weather-collector.zip s3://weatherdatacode-bucket-11-07-2025-12-20-AM-avar/
       aws lambda weather_collector_lambda \
       --function-name weather-data-collector \
       --s3-bucket s3://weatherdatacode-bucket-11-07-2025-12-20-AM-avar \
       --s3-key weather-collector.zip

    - name: Destroy Ephemeral Resources
      run: |
       cd terraform
       terraform init
       terraform apply -var="create_ephemeral_resources_flag=false" -auto-approve

